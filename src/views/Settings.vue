<template>
  <b-container>
    <h1>Settings</h1>
    <div> <!-- todo: button group -->
      <b-button v-b-modal.modal-export variant="info" size="sm">Export</b-button>
      <b-button v-b-modal.modal-import variant="danger" size="sm" class="ml-2">Import</b-button>
    </div>
    <b-modal id="modal-export" hide-footer title="Copy the following value:">
      <b-textarea ref="area" v-model="exportString" @click="$refs.area.select()" readonly rows="10" />
    </b-modal>
    <b-modal id="modal-import" hide-footer title="Paste the settings value:">
      <b-textarea ref="area" v-model="settingsInput" rows="10" />
      <b-button class="mt-3" variant="danger" block @click="doImport()">Import</b-button>
    </b-modal>
  </b-container>
</template>

<script>
import { createNamespacedHelpers } from 'vuex'
import { SETTINGS_DATA_SET } from '@/store/actions/settings'

const { mapGetters, mapMutations } = createNamespacedHelpers('settings')
const passphrase = '123'

function merge (data, newData) {
  Object.keys(newData).forEach(k => {
    const current = data[k]
    if (current) {
      if (typeof current === 'object') {
        merge(current, newData[k])
      } else {
        data[k] = newData[k]
      }
    }
  })
}

export default {
  name: 'Settings',
  data () {
    return {
      settingsInput: ''
    }
  },
  computed: {
    ...mapGetters(['data']),
    exportString () {
      const json = JSON.stringify(this.data)
      const encrypted = this.CryptoJS.AES.encrypt(json, passphrase)
      return encrypted.toString()
    }
  },
  methods: {
    ...mapMutations({
      setData: SETTINGS_DATA_SET
    }),
    doImport () {
      this.importString(this.settingsInput)
      this.$bvModal.hide('modal-import')
    },
    importString (value) {
      try {
        const decrypted = this.CryptoJS.AES.decrypt(value, passphrase).toString(this.CryptoJS.enc.Utf8)
        const parsed = JSON.parse(decrypted)
        const current = JSON.parse(JSON.stringify(this.data))
        merge(current, parsed)

        this.setData(current)

        this.$bvToast.toast('Settings were imported!', {
          title: 'Import success',
          autoHideDelay: 5000,
          variant: 'success'
        })
      } catch (e) {
        this.$bvToast.toast(e.toString(), {
          title: 'Import error',
          autoHideDelay: 5000,
          variant: 'danger'
        })
      }
    }
  }
}
</script>
